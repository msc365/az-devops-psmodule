name: Modernize Azure DevOps PowerShell Cmdlet
description: Modernize and standardize Azure DevOps PowerShell module cmdlets following the established pattern from Core/Projects folder
version: 1.0.0

rules:
    - title: Replace Legacy Global Variables
      pattern: |
          Remove usage of:
          - $global:AzDevOpsIsConnected
          - $global:AzDevOpsOrganization
          - $AzDevOpsAuth
          - Direct Invoke-RestMethod calls

          Replace with:
          - CollectionUri parameter with validation
          - ProjectName parameter with validation
          - Invoke-AdoRestMethod helper function
          - Confirm-Default for default value validation

    - title: Standardize Parameter Naming
      pattern: |
          Use consistent parameter naming:
          - ProjectName (not Project) with ProjectId alias
          - Get cmdlets: Use -Name for filtering/retrieving
          - New cmdlets: Use -Name for new item name
          - Set cmdlets: Use -Id for target, -Name for new name
          - Remove cmdlets: Use -Id for target to remove
          - Add backward compatibility aliases (Team, TeamId, TeamName, etc.)

    - title: Add Modern Cmdlet Features
      pattern: |
          - Add [CmdletBinding(SupportsShouldProcess)]
          - Add CollectionUri parameter with ValidateScript
          - Add pipeline support (ValueFromPipeline, ValueFromPipelineByPropertyName)
          - Use array parameters with foreach loops
          - Add proper Write-Verbose and Write-Debug statements
          - Use Confirm-Default helper in begin block

    - title: Consolidate List Cmdlets
      pattern: |
          Merge Get-Ado[Type] and Get-Ado[Type]List into single cmdlet:
          - Make Name/Id parameter optional
          - Add Skip and Top parameters for pagination
          - Use DefaultParameterSetName = 'List[Type]s'
          - Use ParameterSetName = 'ByName' or 'ByNameOrId' for specific items
          - Delete the List cmdlet file after consolidation

    - title: Use Efficient Code Structure
      pattern: |
          Follow Get-AdoProject pattern for efficiency:
          - Use a robust foreach pattern:
              $namesToProcess = if ($Name) { $Name } else { @($null) }
              foreach ($n_ in $namesToProcess) { ... }
          - This ensures the loop runs once for 'list all' when $Name is not provided, and once per name when $Name is specified.
          - Build URI conditionally inside loop
          - Use List[string] for query parameters
          - Use ternary operators in ShouldProcess
          - Normalize results: $items = if ($n_) { @($results) } else { $results.value }

    - title: Proper Body Handling for POST/PUT/PATCH
      pattern: |
          For cmdlets that send data (New/Set):
          - Create body as [PSCustomObject] (not hashtable)
          - Use hashtables for nested objects (Azure API accepts both)
          - Do NOT add Body to $params hashtable
          - Pipe body to Invoke-AdoRestMethod using pipeline input
          - Let Invoke-AdoRestMethod handle JSON serialization
          - Example: $results = $body | Invoke-AdoRestMethod @params

    - title: Error Handling Pattern
      pattern: |
          Use proper error handling with ErrorDetails.Message matching:
          - Wrap REST API calls in try/catch blocks
          - Inner try/catch for specific error scenarios (404, already exists, etc.)
          - Check $_.ErrorDetails.Message -match 'ExceptionTypeName' for specific errors
          - Use Write-Warning for expected/graceful errors (not found, already exists)
          - Re-throw unexpected errors with throw $_
          - Outer try/catch for general error handling

          Common pattern (most functions):
          process {
              try {
                  if ($PSCmdlet.ShouldProcess(...)) {
                      try {
                          $results = Invoke-AdoRestMethod @params
                          # Process results
                      } catch {
                          if ($_.ErrorDetails.Message -match 'NotFoundException') {
                              Write-Warning "[Type] with ID $Name does not exist, skipping."
                          } else {
                              throw $_
                          }
                      }
                  }
              } catch {
                  throw $_
              }
          }

          Note: Projects use specific exceptions (ProjectDoesNotExistWithNameException, ProjectAlreadyExistsException)
          New cmdlets may use specific exceptions (TeamAlreadyExistsException, ProjectAlreadyExistsException)

    - title: Name-to-ID Resolution Pattern
      pattern: |
          For Set/Remove cmdlets that accept name or ID:
          - Try to parse input as GUID first
          - If parsing fails, treat as name and call Get cmdlet to resolve
          - Use continue keyword if resolution fails (for array processing)
          - Only proceed with resolved ID

          Example:
          try {
              [System.Guid]::Parse($Id) | Out-Null
              $projectId = $Id
          } catch {
              $projectId = (Get-AdoProject -CollectionUri $CollectionUri -Name $Id).id
              if (-not $projectId) { continue }
          }

    - title: Continuation Token Pattern for Pagination
      pattern: |
          For Get (list) cmdlets that support continuation tokens:
          - Add ContinuationToken parameter to List parameter set
          - Build output object with ordered hashtable first
          - Conditionally add continuationToken to output if present
          - Always add projectName and collectionUri after optional properties
          - Convert to PSCustomObject at the end

          Example:
          foreach ($i_ in $items) {
              $obj = [ordered]@{
                  id          = $i_.id
                  name        = $i_.name
                  description = $i_.description
                  # ... other required properties
              }
              # Conditionally add optional properties
              if ($i_.continuationToken) {
                  $obj['continuationToken'] = $i_.continuationToken
              }
              # Always add these last
              $obj['projectName'] = $ProjectName
              $obj['collectionUri'] = $CollectionUri

              [PSCustomObject]$obj
          }

template: |
    function Get-Ado[Type] {
        <#
        .SYNOPSIS
            Retrieves Azure DevOps [type] details.

        .DESCRIPTION
            This cmdlet retrieves details of one or more Azure DevOps [type]s within a specified [scope].
            You can retrieve all [type]s, or specific [type]s by name or ID.

        .PARAMETER CollectionUri
            Optional. The collection URI of the Azure DevOps collection/organization, e.g., https://dev.azure.com/my-org.

        .PARAMETER ProjectName
            Mandatory. The ID or name of the project.

        .PARAMETER Name
            Optional. The ID or name of the [type](s) to retrieve. If not provided, retrieves all [type]s.

        .PARAMETER Skip
            Optional. The number of [type]s to skip. Used for pagination.

        .PARAMETER Top
            Optional. The number of [type]s to retrieve. Used for pagination. Default is 100.

        .PARAMETER Version
            Optional. The API version to use for the request. Default is '[version]'.

        .LINK
            https://learn.microsoft.com/en-us/rest/api/azure/devops/[area]/[resource]

        .EXAMPLE
            $params = @{
                CollectionUri = 'https://dev.azure.com/my-org'
                ProjectName   = 'my-project-1'
            }
            Get-Ado[Type] @params

            Retrieves all [type]s from the specified project.

        .EXAMPLE
            $params = @{
                CollectionUri = 'https://dev.azure.com/my-org'
                ProjectName   = 'my-project-1'
            }
            Get-Ado[Type] @params -Name 'my-[type]'

            Retrieves the specified [type] from the project.
        #>
        [CmdletBinding(DefaultParameterSetName = 'List[Type]s', SupportsShouldProcess)]
        param (
            [Parameter(ValueFromPipelineByPropertyName)]
            [ValidateScript({ Confirm-CollectionUri -Uri $_ })]
            [string]$CollectionUri = $env:DefaultAdoCollectionUri,

            [Parameter(ValueFromPipelineByPropertyName)]
            [Alias('ProjectId')]
            [string]$ProjectName = $env:DefaultAdoProject,

            [Parameter(ValueFromPipelineByPropertyName, ValueFromPipeline, ParameterSetName = 'ByName')]
            [Alias('[Type]', '[Type]Id', '[Type]Name')]
            [string[]]$Name,

            [Parameter(ParameterSetName = 'List[Type]s')]
            [int]$Skip,

            [Parameter(ParameterSetName = 'List[Type]s')]
            [int]$Top = 100,

            [Parameter(ParameterSetName = 'List[Type]s')]
            [string]$ContinuationToken,

            [Parameter()]
            [Alias('ApiVersion')]
            [ValidateSet('[versions]')]
            [string]$Version = '[default-version]'
        )

        begin {
            Write-Verbose ("Command: $($MyInvocation.MyCommand.Name)")
            Write-Debug ("CollectionUri: $CollectionUri")
            Write-Debug ("ProjectName: $ProjectName")
            Write-Debug ("Name: $($Name -join ',')")
            Write-Debug ("Skip: $Skip")
            Write-Debug ("Top: $Top")
            Write-Debug ("ContinuationToken: $ContinuationToken")
            Write-Debug ("Version: $Version")

            Confirm-Default -Defaults ([ordered]@{
                    'CollectionUri' = $CollectionUri
                    'ProjectName'   = $ProjectName
                })
        }

        process {
            try {

                foreach ($n_ in $Name) {
                    $queryParameters = [System.Collections.Generic.List[string]]::new()

                    if ($n_) {
                        $uri = "$CollectionUri/_apis/projects/$ProjectName/[resources]/$n_"
                    } else {
                        $uri = "$CollectionUri/_apis/projects/$ProjectName/[resources]"

                        # Build query parameters
                        if ($Skip) {
                            $queryParameters.Add("`$skip=$Skip")
                        }
                        if ($Top) {
                            $queryParameters.Add("`$top=$Top")
                        }
                        if ($ContinuationToken) {
                            $queryParameters.Add("continuationToken=$ContinuationToken")
                        }
                    }

                    $params = @{
                        Uri             = $uri
                        Version         = $Version
                        QueryParameters = if ($queryParameters.Count -gt 0) { $queryParameters -join '&' } else { $null }
                        Method          = 'GET'
                    }

                    if ($PSCmdlet.ShouldProcess($CollectionUri, $n_ ? "Get [Type] '$($n_)' in project '$($ProjectName)'" : "Get [Type]s for project '$($ProjectName)'")) {

                        try {
                            $results = Invoke-AdoRestMethod @params
                            $items = if ($n_) { @($results) } else { $results.value }

                            foreach ($i_ in $items) {
                                $obj = [ordered]@{
                                    id          = $i_.id
                                    name        = $i_.name
                                    description = $i_.description
                                    # Add additional properties as needed
                                }
                                # Conditionally add optional properties like continuation tokens
                                if ($i_.continuationToken) {
                                    $obj['continuationToken'] = $i_.continuationToken
                                }
                                # Always add these last
                                $obj['projectName'] = $ProjectName
                                $obj['collectionUri'] = $CollectionUri

                                # Output the object
                                [PSCustomObject]$obj
                            }

                        } catch {
                            if ($_.ErrorDetails.Message -match 'NotFoundException') {
                                Write-Warning "[Type] with ID $Name does not exist in project $ProjectName, skipping."
                            } else {
                                throw $_
                            }
                        }

                    } else {
                        Write-Verbose "Calling Invoke-AdoRestMethod with $($params | ConvertTo-Json -Depth 10)"
                    }
                }

            } catch {
                throw $_
            }

        }

        end {
            Write-Verbose ("Exit: $($MyInvocation.MyCommand.Name)")
        }
    }

examples:
    - description: Modernize a basic Get cmdlet
      before: |
          function Get-AdoTeam {
              param (
                  [Parameter(Mandatory)]
                  [string]$ProjectId,

                  [Parameter(Mandatory)]
                  [string]$TeamId
              )

              if (-not $global:AzDevOpsIsConnected) {
                  throw 'Not connected'
              }

              $uri = "$global:AzDevOpsOrganization/_apis/projects/$ProjectId/teams/$TeamId"
              Invoke-RestMethod -Uri $uri -Headers @{ Authorization = $AzDevOpsAuth }
          }

      after: |
          function Get-AdoTeam {
              [CmdletBinding(DefaultParameterSetName = 'ListTeams', SupportsShouldProcess)]
              param (
                  [Parameter(ValueFromPipelineByPropertyName)]
                  [ValidateScript({ Confirm-CollectionUri -Uri $_ })]
                  [string]$CollectionUri = $env:DefaultAdoCollectionUri,

                  [Parameter(Mandatory, ValueFromPipelineByPropertyName)]
                  [Alias('ProjectId')]
                  [string]$ProjectName,

                  [Parameter(ValueFromPipelineByPropertyName, ValueFromPipeline, ParameterSetName = 'ByName')]
                  [Alias('Team', 'TeamId', 'TeamName')]
                  [string[]]$Name,

                  [Parameter(ParameterSetName = 'ListTeams')]
                  [int]$Skip,

                  [Parameter(ParameterSetName = 'ListTeams')]
                  [int]$Top = 100
              )

              begin {
                  Confirm-Default -Defaults ([ordered]@{
                      'CollectionUri' = $CollectionUri
                      'ProjectName'   = $ProjectName
                  })
              }

              process {
                  try {
                      foreach ($n_ in $Name) {
                          if ($n_) {
                              $uri = "$CollectionUri/_apis/projects/$ProjectName/teams/$n_"
                          } else {
                              $uri = "$CollectionUri/_apis/projects/$ProjectName/teams"
                          }

                          $params = @{
                              Uri     = $uri
                              Version = '7.2-preview.3'
                              Method  = 'GET'
                          }

                          if ($PSCmdlet.ShouldProcess($CollectionUri, $n_ ? "Get Team '$($n_)' in project '$($ProjectName)'" : "Get Teams for project '$($ProjectName)'")) {
                              try {
                                  $results = Invoke-AdoRestMethod @params
                                  $teams = if ($n_) { @($results) } else { $results.value }

                                  foreach ($t_ in $teams) {
                                      [PSCustomObject]@{
                                          id            = $t_.id
                                          name          = $t_.name
                                          collectionUri = $CollectionUri
                                      }
                                  }
                              } catch {
                                  if ($_.ErrorDetails.Message -match 'NotFoundException') {
                                      Write-Warning "Team with ID $n_ does not exist, skipping."
                                  } else {
                                      throw $_
                                  }
                              }
                          }
                      }
                  } catch {
                      throw $_
                  }
              }
          }

    - description: Modernize New cmdlet with error handling
      before: |
          function New-AdoProject {
              param (
                  [Parameter(Mandatory)]
                  [string]$Name
              )

              $uri = "$global:AzDevOpsOrganization/_apis/projects"
              $body = @{ name = $Name } | ConvertTo-Json
              Invoke-RestMethod -Uri $uri -Method Post -Body $body -Headers @{ Authorization = $AzDevOpsAuth }
          }

      after: |
          function New-AdoProject {
              [CmdletBinding(SupportsShouldProcess, ConfirmImpact = 'High')]
              param (
                  [Parameter(ValueFromPipelineByPropertyName)]
                  [ValidateScript({ Confirm-CollectionUri -Uri $_ })]
                  [string]$CollectionUri = $env:DefaultAdoCollectionUri,

                  [Parameter(Mandatory, ValueFromPipelineByPropertyName, ValueFromPipeline)]
                  [string[]]$Name,

                  [Parameter(ValueFromPipelineByPropertyName)]
                  [string]$Description
              )

              begin {
                  Confirm-Default -Defaults ([ordered]@{
                      'CollectionUri' = $CollectionUri
                  })
              }

              process {
                  try {
                      $params = @{
                          Uri     = "$CollectionUri/_apis/projects"
                          Version = '7.1'
                          Method  = 'POST'
                      }

                      foreach ($name_ in $Name) {
                          $body = [PSCustomObject]@{
                              name        = $name_
                              description = $Description
                          }

                          if ($PSCmdlet.ShouldProcess($CollectionUri, "Create project: $name_")) {
                              try {
                                  $results = $body | Invoke-AdoRestMethod @params

                                  # Get the created project details
                                  $results = Get-AdoProject -CollectionUri $CollectionUri -Name $name_

                                  [PSCustomObject]@{
                                      id            = $results.id
                                      name          = $results.name
                                      description   = $results.description
                                      collectionUri = $CollectionUri
                                  }
                              } catch {
                                  if ($_.ErrorDetails.Message -match 'ProjectAlreadyExistsException') {
                                      Write-Warning "Project $name_ already exists, trying to get it"
                                      $results = Get-AdoProject -CollectionUri $CollectionUri -Name $name_
                                      [PSCustomObject]@{
                                          id            = $results.id
                                          name          = $results.name
                                          description   = $results.description
                                          collectionUri = $CollectionUri
                                      }
                                  } else {
                                      throw $_
                                  }
                              }
                          }
                      }
                  } catch {
                      throw $_
                  }
              }
          }

    - description: Modernize Set cmdlet with name-to-ID resolution
      before: |
          function Set-AdoProject {
              param (
                  [Parameter(Mandatory)]
                  [string]$ProjectId,

                  [Parameter()]
                  [string]$Name
              )

              $uri = "$global:AzDevOpsOrganization/_apis/projects/$ProjectId"
              $body = @{ name = $Name } | ConvertTo-Json
              Invoke-RestMethod -Uri $uri -Method Patch -Body $body -Headers @{ Authorization = $AzDevOpsAuth }
          }

      after: |
          function Set-AdoProject {
              [CmdletBinding(SupportsShouldProcess, ConfirmImpact = 'High')]
              param (
                  [Parameter(ValueFromPipelineByPropertyName)]
                  [ValidateScript({ Confirm-CollectionUri -Uri $_ })]
                  [string]$CollectionUri = $env:DefaultAdoCollectionUri,

                  [Parameter(Mandatory, ValueFromPipelineByPropertyName, ValueFromPipeline)]
                  [Alias('ProjectId')]
                  [string]$Id,

                  [Parameter(ValueFromPipelineByPropertyName)]
                  [Alias('ProjectName')]
                  [string]$Name,

                  [Parameter(ValueFromPipelineByPropertyName)]
                  [string]$Description
              )

              begin {
                  Confirm-Default -Defaults ([ordered]@{
                      'CollectionUri' = $CollectionUri
                  })
              }

              process {
                  try {
                      # Get id when name was provided, id is required for update
                      try {
                          [System.Guid]::Parse($Id) | Out-Null
                          $projectId = $Id
                      } catch {
                          $projectId = (Get-AdoProject -CollectionUri $CollectionUri -Name $Id).id
                          if (-not $projectId) { continue }
                      }

                      $params = @{
                          Uri     = "$CollectionUri/_apis/projects/$projectId"
                          Version = '7.1'
                          Method  = 'PATCH'
                      }

                      $body = [PSCustomObject]@{}
                      if ($PSBoundParameters.ContainsKey('Name')) {
                          $body | Add-Member -NotePropertyName 'name' -NotePropertyValue $Name
                      }
                      if ($PSBoundParameters.ContainsKey('Description')) {
                          $body | Add-Member -NotePropertyName 'description' -NotePropertyValue $Description
                      }

                      if ($PSCmdlet.ShouldProcess($CollectionUri, "Update project: $Id")) {
                          try {
                              $results = $body | Invoke-AdoRestMethod @params

                              # Get the updated project details
                              $results = Get-AdoProject -CollectionUri $CollectionUri -Id $projectId

                              [PSCustomObject]@{
                                  id            = $results.id
                                  name          = $results.name
                                  description   = $results.description
                                  collectionUri = $CollectionUri
                              }
                          } catch {
                              if ($_.ErrorDetails.Message -match 'ProjectDoesNotExistWithNameException') {
                                  Write-Warning "Project with ID $Id does not exist, skipping."
                              } else {
                                  throw $_
                              }
                          }
                      }
                  } catch {
                      throw $_
                  }
              }
          }

    - description: Consolidate Get and GetList cmdlets
      note: |
          When you have separate Get-Ado[Type] and Get-Ado[Type]List cmdlets:
          1. Merge functionality into Get-Ado[Type]
          2. Make Name parameter optional
          3. Add Skip and Top parameters with ParameterSetName
          4. Use single foreach loop pattern
          5. Delete Get-Ado[Type]List.ps1 file

checklist:
    - Update parameter names (ProjectName, Name/Id pattern)
    - Add CollectionUri with validation
    - Replace global variables with parameters
    - Replace Invoke-RestMethod with Invoke-AdoRestMethod
    - Add Confirm-Default in begin block
    - Add SupportsShouldProcess
    - Add pipeline support attributes
    - Add parameter set names for Get cmdlets
    - Use single foreach loop pattern
    - Add proper error handling with try/catch and ErrorDetails.Message matching
    - Use Write-Warning for expected errors (not found, already exists)
    - Re-throw unexpected errors with throw $_
    - Add Write-Verbose and Write-Debug statements
    - Add backward compatibility aliases
    - Include collectionUri and projectName in output objects
    - Build output objects using ordered hashtable, add optional properties conditionally, then convert to PSCustomObject
    - For list cmdlets: Add ContinuationToken parameter and conditionally include it in output if present
    - For POST/PUT/PATCH: Use [PSCustomObject] for body, pipe to Invoke-AdoRestMethod (not in $params)
    - For Set/Remove: Add name-to-ID resolution with GUID parsing
    - Update help documentation
    - Update examples to use new pattern

notes:
    - Always maintain backward compatibility through aliases
    - Use ternary operators for cleaner conditionals (PowerShell 7+)
    - Pattern works for Core, Graph, Pipeline, Work, and other folders
    - Reference Get-AdoProject as the gold standard implementation
    - Set cmdlets use -Id for target identification, -Name for new name value
    - Remove cmdlets use -Id for target identification
    - New cmdlets use -Name for the new item name
    - Error handling checks $_.ErrorDetails.Message -match 'ExceptionTypeName' for specific Azure DevOps exceptions
    - Most functions use generic 'NotFoundException' for not found errors
    - Project functions use specific exceptions: ProjectDoesNotExistWithNameException, ProjectAlreadyExistsException
    - New cmdlets may use specific [Type]AlreadyExistsException (e.g., TeamAlreadyExistsException)
    - Name-to-ID resolution uses [System.Guid]::Parse() to differentiate between GUID and name inputs
    - Use 'continue' keyword in catch blocks when processing arrays to skip failed items and continue with next
    - ContinuationToken should be used for APIs that support cursor-based pagination (not Skip/Top)
    - Build output objects with ordered hashtable first, conditionally add optional properties, always add projectName and collectionUri last
